<!DOCTYPE html>
<meta charset="utf-8">
<script src="./build/js/d3.min.js"></script>
<script src="./build/js/js-yaml.min.js"></script>

<script>
function cloneObject(obj) {
    if (obj === null || typeof obj !== 'object') {
        return obj;
    }
    var temp = obj.constructor(); // give temp the original obj's constructor
    for (var key in obj) {
        temp[key] = cloneObject(obj[key]);
    }
    return temp;
}

var module = {}
var fonts = {}
</script>
<script src="./build/fonts/azure-enterprise.js"></script>
<script>
fonts['azure-enterprise'] = cloneObject(module.exports)
</script>
<script>
</script>
<script src="./build/fonts/cisco.js"></script>
<script>
fonts['cisco'] = cloneObject(module.exports)
</script>

<link rel="stylesheet" type="text/css" href="./build/fonts/azure-enterprise.css">
<link rel="stylesheet" type="text/css" href="./build/fonts/cisco.css">

<style> /* set the CSS */


body {
    font: normal 12px Verdana, Arial, sans-serif;
}

.axisNone line{
  stroke: #AAAAAA;
}

.axisNone path{
  stroke: none;
}

.axisNone text{
  fill: #AAAAAA;
}

.grid line {
  stroke: #AAAAAA;
  stroke-opacity: 0.7;
  stroke-width: 1px;
  shape-rendering: crispEdges;
}

.grid path {
  stroke-width: 0;
}

</style>
<body>

<script>
var yml = `
backgroundColor: "#3d3935"
diagramAspectRatio: "11:11"
rows: 5
columns: 5
gridLines: false
margin:
  top: 20
  right: 20
  bottom: 50
  left: 20
defaults: &defaults
  font: "azure-enterprise"
cisco: &cisco
  borderColor: "#004BAF"
  color: "#004BAF"
  iconColor: "#004BAF"
  font: "cisco"
  backgroundColor: "white"
servers: &servers
  <<: *defaults
  type: "Webserver"
  backgroundColor: "#58585B"
devices:
  firewall: {<<: *cisco, x: 4, y: 4, type: "firewall"}
  chddc1crt001: {<<: *cisco, x: 0, y: 4, type: "router"}
  chddc1crt004: {x: 2, y: 3, font: "azure-enterprise", type: "Gateway", backgroundColor: "Gold"}
  chddc1sfw005: {x: 2, y: 2, font: "azure-enterprise", type: "Firewall", backgroundColor: "red"}
  chddc1srt001: {x: 3, y: 2, font: "azure-enterprise", type: "Gateway", backgroundColor: "green"}
  chddc1slb005: {x: 3, y: 1, font: "azure-enterprise", type: "LoadbalancerGeneric", backgroundColor: "#2E1700"}
  lx12300: {<<: *servers, x: 2, y: 0}
  lx12301: {<<: *servers, x: 3, y: 0}
  lx12302: {<<: *servers, x: 4, y: 0}

connection: &connection
  lineColor: "white"
  strokeDashArray: "10,2"
connections:
  - { <<: *connection, start: "firewall", finish: "chddc1crt001" }
  - { <<: *connection, start: "chddc1crt001", finish: "chddc1crt004" }
  - { <<: *connection, start: "chddc1crt004", finish: "chddc1sfw005" }
  - { <<: *connection, start: "chddc1sfw005", finish: "chddc1srt001" }
  - { <<: *connection, start: "chddc1srt001", finish: "chddc1slb005" }
  - { <<: *connection, start: "chddc1slb005", finish: "lx12300" }
  - { <<: *connection, start: "chddc1slb005", finish: "lx12301" }
  - { <<: *connection, start: "chddc1slb005", finish: "lx12302" }
`;

var doc = jsyaml.load(yml);
document.body.style.background =  doc.backgroundColor || "red";

var ratios = doc['diagramAspectRatio'].split(':')
var margin = doc['margin'] || {top: 20, right: 20, bottom: 50, left: 20}

if (window.innerHeight < window.innerWidth) {
  height = window.innerHeight - doc.margin.top - doc.margin.bottom
  width = window.innerHeight/ratios[1] * ratios[0] - doc.margin.left - doc.margin.right
} else if (window.innerWidth < window.innerHeight) {
  width = window.innerWidth - doc.margin.left - doc.margin.right
  height = window.innerWidth/ratios[0] * ratios[1] - doc.margin.top - doc.margin.bottom
} else {
  width = window.innerWidth
  height = window.innerHeight
}

var rows = doc.rows || 10
var columns = doc.columns || 10

var x = d3.scaleBand()
  .domain(Array.from(Array(columns).keys()))
  .rangeRound([0,width])
  .paddingInner(0.2);

var y = d3.scaleBand()
  .domain(Array.from(Array(rows).keys()).reverse())
  .rangeRound([0,height])
  .paddingInner(0.2);

var svg = d3.select("body").append("svg")
  .attr("width", window.innerWidth )
  .attr("height", window.innerHeight )
  .style("background-color", function(d) { return doc.backgroundColor || "white" })
  .append("g")
    .attr("transform", "translate(" + (window.innerWidth - width)/2 + "," + (window.innerHeight - height)/2 + ")");

function make_x_gridlines() {
  return d3.axisBottom(x)
      .ticks(5)
}

// gridlines in y axis function
function make_y_gridlines() {
  return d3.axisLeft(y)
      .ticks(5)
}
if (doc.gridLines) {
  svg.append("g")
    .attr("class", "grid")
    .attr("transform", "translate(0," + height + ")")
    .call(make_x_gridlines()
      .tickSize(-height)
      .tickFormat("")
      .ticks(columns)
    )
  svg.append("g")
    .attr("class", "grid")
    .call(make_y_gridlines()
      .tickSize(-width)
      .tickFormat("")
      .ticks(rows)
    )

    // add the X Axis
  svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .attr("class", "axisNone")
    .call(d3.axisBottom(x));

    // add the Y Axis
  svg.append("g")
    .attr("class", "axisNone")
    .call(d3.axisLeft(y));
}

if (doc.connections) {
  var connectionsAll = svg.selectAll("connections")
    .data(doc.connections)
    .enter()
    .append("line")

  var connectionAttributes = connectionsAll
    .style("stroke", function(d) { return d.lineColor || "orange" })
    .style("stroke-dasharray", function(d) { return d.strokeDashArray || "0,0" } )
    .attr("x1", function(d) { return x(doc.devices[d.start].x) + x.bandwidth()/2 })
    .attr("y1", function(d) { return y(doc.devices[d.start].y) + y.bandwidth()/2 })
    .attr("x2", function(d) { return x(doc.devices[d.finish].x) + x.bandwidth()/2 })
    .attr("y2", function(d) { return y(doc.devices[d.finish].y) + y.bandwidth()/2 })
}

var deviceCellsAll = svg.selectAll("cells")
  .data(d3.entries(doc.devices))
  .enter()

var cells = deviceCellsAll.append("g")
  .attr("transform", function(d) { return "translate(" + x(d.value.x) + "," + y(d.value.y) + ")" })

var cellFill = cells
  .append("rect")
  .attr("rx", x.bandwidth() * .05)
  .attr("ry", y.bandwidth() * .05)
  .attr("width", x.bandwidth() )
  .attr("height", y.bandwidth() )
  .attr("fill", function(d) { return d.value.backgroundColor })
  .style("stroke", function(d) { return d.value.borderColor || 'none' })


var cellText = cells
  .append("text")
  .text( function (d) { return d.key })
  .attr("x", x.bandwidth()/2 )
  .attr("y", y.bandwidth()*.95 )
  .attr("text-anchor", "middle")
  .style("font-size", function(d) { return Math.min(x.bandwidth()*.9 / this.getComputedTextLength() * 12, y.bandwidth()/3/2) + "px"; })
  .attr('fill', function(d) { return d.value.color || "white"} )

var icon = cells
  .append('text')
  .attr("x", x.bandwidth()/2 )
  .attr("y", y.bandwidth() * .4 )
  .attr('text-anchor', 'middle')
  .attr('dominant-baseline', 'central')
  .style('font-family', function(d) { return d.value.font })
  .style('font-size', Math.min(x.bandwidth()*.9,y.bandwidth()*.8*.9)  + 'px')
  .attr('fill', function(d) { return d.value.iconColor || "white"} )
  .text(function (d) {
       return fonts[d.value.font][d.value.type];
    });

</script>
