<!DOCTYPE html>
<html ng-app="dld4e">
<head>
    <!-- META -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="index,follow">
    <meta name="description" content="decent looking diagrams for engineers">

    <link rel="icon"
      type="image/png"
      href="./build/images/radial.png" />

    <title>Decent looking diagrams for engineers</title>

    <link rel="stylesheet" href="build/css/bootstrap.min.css">
    <link rel="stylesheet" href="build/css/font-awesome.min.css">
    <link rel="stylesheet" href="build/css/app.css">
    <link rel="stylesheet" href="build/css/notes.css">

    <script type="text/javascript" src="build/js/angular.min.js"></script>
    <script type="text/javascript" src="build/js/angular-animate.min.js"></script>
    <script type="text/javascript" src="build/js/ace.js"></script>
    <script type="text/javascript" src="build/js/ui-ace.min.js"></script>
    <script type="text/javascript" src="build/js/ui-bootstrap.min.js"></script>
    <script type="text/javascript" src="build/js/ui-bootstrap-tpls.min.js"></script>
    <script type="text/javascript" src="build/js/js-yaml.min.js"></script>
    <script type="text/javascript" src="./build/js/d3.min.js"></script>
    <script type="text/javascript" src="./build/js/showdown.js"></script>
    <script type="text/javascript" src="./build/js/showdown-prettify.min.js"></script>
    <script type="text/javascript" src="./build/js/prettify/run_prettify.js"></script>

    <script type="text/javascript" src="build/js/dld4e-connections.js"></script>
    <script type="text/javascript" src="build/js/dld4e-draw.js"></script>
    <script type="text/javascript" src="build/js/dld4e-gridlines.js"></script>
    <script type="text/javascript" src="build/js/dld4e-groups.js"></script>
    <script type="text/javascript" src="build/js/dld4e-icons.js"></script>
    <script type="text/javascript" src="build/js/dld4e-title.js"></script>
    <script type="text/javascript" src="build/js/dld4e-notes.js"></script>
    <script type="text/javascript" src="build/js/dld4e-process.js"></script>


    <script type="text/javascript" src="build/js/app.js"></script>

</head>
<body ng-controller="mainController">
      <uib-alert class="col-sm-6 col-sm-offset-3" ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">
        <span ng-bind-html="alert.msg"></span>
      </uib-alert>
      <div class="row">
        <div class="col-sm-6">
          <div class="row">
            <big><strong>Template</strong></big>
            <div class="btn-toolbar pull-right">
              <div class="btn-group" uib-dropdown is-open="status.isopen1">
                <button id="examples" type="button" class="btn btn-black btn-xs pull-right" uib-dropdown-toggle ng-disabled="disabled">
                  Examples<span class="caret"></span>
                </button>
                <ul class="dropdown-menu" uib-dropdown-menu role="menu" aria-labelledby="examples">
                  <li role="menuitem" ng-click="example('curves.yaml')"><a href="#">Curves</a></li>
                  <li role="menuitem" ng-click="example('groups.yaml')"><a href="#">Groups</a></li>
                  <li role="menuitem" ng-click="example('group connections.yaml')"><a href="#">Group connections</a></li>
                  <li role="menuitem" ng-click="example('labels.yaml')"><a href="#">Labels</a></li>
                  <li role="menuitem" ng-click="example('notes.yaml')"><a href="#">Notes</a></li>
                  <li role="menuitem" ng-click="example('NTP.yaml')"><a href="#">NTP</a></li>
                  <li role="menuitem" ng-click="example('relative positions.yaml')"><a href="#">Relative positions</a></li>
                  <li role="menuitem" ng-click="example('sample.yaml')"><a href="#">Sample</a></li>
                  <li role="menuitem" ng-click="example('text locations.yaml')"><a href="#">Text locations</a></li>

                </ul>
              </div>
              <div class="btn-group" uib-dropdown is-open="status.isopen2">
                <button id="foo" type="button" class="btn btn-black btn-xs pull-right" uib-dropdown-toggle ng-disabled="disabled">
                  Icons<span class="caret"></span>
                </button>
                <ul class="dropdown-menu" uib-dropdown-menu role="menu" aria-labelledby="icons">
                  <li role="menuitem" ng-click="drawIconFamily('aws-native')"><a href="#">aws</a></li>
                  <li role="menuitem" ng-click="drawIconFamily('aws-filled')"><a href="#">aws (iconFill)</a></li>
                  <li role="menuitem" ng-click="drawIconFamily('aws-stroke')"><a href="#">aws (iconStroke)</a></li>
                  <li role="menuitem" ng-click="drawIconFamily('cisco-native')"><a href="#">cisco</a></li>
                  <li role="menuitem" ng-click="drawIconFamily('cisco-filled')"><a href="#">cisco (iconFill)</a></li>
                  <li role="menuitem" ng-click="drawIconFamily('cisco-stroke')"><a href="#">cisco (iconStroke)</a></li>
                  <li role="menuitem" ng-click="drawIconFamily('azureEnterprise-native')"><a href="#">azureEnterprise</a></li>
                  <li role="menuitem" ng-click="drawIconFamily('azureEnterprise-filled')"><a href="#">azureEnterprise (iconFill)</a></li>
                  <li role="menuitem" ng-click="drawIconFamily('azureEnterprise-stroke')"><a href="#">azureEnterprise (iconStroke)</a></li>
                  <li role="menuitem" ng-click="drawIconFamily('azureCloud-native')"><a href="#">azureCloud</a></li>
                  <li role="menuitem" ng-click="drawIconFamily('azureCloud-filled')"><a href="#">azureCloud (iconFill)</a></li>
                  <li role="menuitem" ng-click="drawIconFamily('azureCloud-stroke')"><a href="#">azureCloud (iconStroke)</a></li>

                </ul>
              </div>
              <button id="draw" type="submit" class="btn btn-black btn-xs pull-right" ng-click="drawClick(value)" uib-tooltip="hint: press ctrl-enter to refresh the drawing" tooltip-placement="bottom" tooltip-append-to-body="true">
                 <span class="glyphicon glyphicon glyphicon-pencil" aria-hidden="true" ></span> Draw
              </button>
            </div>
          </div>
          <div class="row">
            <div ui-ace="aceyamlOptions" ng-model="acedata"></div>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="row">
              <div class="btn-toolbar pull-right">
                <a href="http://github.com/cidrblock/network_diagram" target="_blank" class="btn btn-black btn-xs">
                  <span class="fa fa-github"></span> Github
                </a>
                <button type="submit" class="btn btn-black btn-xs" ng-click="opend3js()">
                   <span class="glyphicon glyphicon glyphicon-new-window" aria-hidden="true"></span> Fullscreen
                </button>
              </div>
          </div>
          <div class="row">
            <div class="drawing" id="svg"></div>
          </div>
        </div>
      </div>
    </div>
</body>

<script>

angular
    .module("dld4e", ['ui.bootstrap', 'ui.ace'])
    .controller("mainController", mainController);

mainController.$inject = ["$scope", "$http", "$sce", "$log", "$window"];

function mainController($scope, $http, $sce, $log, $window) {
  $scope.design = "";
  $http.get('examples/NTP.yaml')
       .then(function(res){
          $scope.acedata = res.data;
          $scope.drawClick()
        });
  $scope.aceyamlOptions = {
    onLoad: function (_ace) {
      _ace.getSession().setMode("ace/mode/yaml");
      _ace.$blockScrolling = Infinity;
      _ace.commands.addCommand({
          name: 'saveFile',
          bindKey: {
          win: 'Ctrl-S',
          mac: 'Command-S',
          sender: 'editor|cli'
          },
          exec: function(env, args, request) {
            $scope.saveFile();
          }
          });
      _ace.setOption("tabSize", 2);
    }
  };
  $scope.opend3js = function(greeting) {
    $window.design = jsyaml.load($scope.acedata) || {};
    var w = $window.open("fullscreen.html");
  };
  $scope.drawIconFamily = function(iconFamily) {
    var wi = window.open('about:blank', '_blank');
    $http.get('./build/js/iconFamilies.json')
     .then(function(res){
       var iconFamilies = res.data
       var bestFit = Math.ceil(Math.sqrt(size))
       var familyName = iconFamily.split('-')[0]
       var size = iconFamilies[familyName].length
       var url = "./templates/" + iconFamily + ".yaml"
       $http.get(url)
            .then(function(res){
               var doc = jsyaml.load(res.data);
               var ratios = doc.diagram.aspectRatio.split(':')
               var h = ratios[0]
               var w = ratios[1]
               doc.diagram.rows = Math.ceil(Math.sqrt(size*w/h))
               doc.diagram.columns = Math.ceil(size/doc.diagram.rows)
               var x = 0
               var y = doc.diagram.rows - 1
               doc.icons = {}
               for (var icon in iconFamilies[familyName]){
                 doc.icons[iconFamilies[familyName][icon]] = Object.assign( { x: x, y: y, icon: iconFamilies[familyName][icon]}, doc.icon)
                 x += 1
                 if (x == doc.diagram.columns) {
                   x = 0
                   y -= 1
                 }
               }
               $window.design = doc;
               wi.location.href = 'fullscreen.html';
             });
    });
  }
  $scope.example = function(file) {
    $http.get("examples/" + file)
         .then(function(res){
            $scope.acedata = res.data;
            $scope.drawClick();
          });
  }
  $scope.drawClick = function() {
    $window.design = jsyaml.load($scope.acedata) || {};
    draw($window.design);
    $window.document.title = 'dld4e: ' + window.design.title.text
  }
  $scope.saveFile = function() {
    var data = $scope.acedata,
        blob = new Blob([data], { type: 'text/plain' }),
        url = $window.URL || $window.webkitURL;
        design = jsyaml.load(data) || {};
        fileName = `${design.title.text || 'dld4e'}-v${design.title.version || '1.01'}.yaml`
    url = url.createObjectURL(blob); //do
    var downloadLink = document.createElement("a");
    downloadLink.href = url;
    downloadLink.download = fileName;
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
  }
};

</script>

</html>
