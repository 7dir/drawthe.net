<!DOCTYPE html>
<html>
<head>
    <!-- META -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
    <meta name="robots" content="index,follow">
    <meta name="description" content="decent looking diagrams for engineers">

    <link rel="icon"
      type="image/png"
      href="./build/images/radial.png" />
    <base href="/">

    <title>Decent looking diagrams for engineers</title>

    <link rel="stylesheet" href="build/css/bootstrap.min.css">
    <link rel="stylesheet" href="build/css/font-awesome.min.css">
    <link rel="stylesheet" href="build/css/app.css">
    <link rel="stylesheet" href="build/css/notes.css">

    <script type="text/javascript" src="build/js/angular.min.js"></script>
    <script type="text/javascript" src="build/js/angular-animate.min.js"></script>
    <script type="text/javascript" src="build/js/ace.js"></script>
    <script type="text/javascript" src="build/js/ui-ace.min.js"></script>
    <script type="text/javascript" src="build/js/ui-bootstrap.min.js"></script>
    <script type="text/javascript" src="build/js/ui-bootstrap-tpls.min.js"></script>
    <script type="text/javascript" src="build/js/js-yaml.min.js"></script>
    <script type="text/javascript" src="./build/js/d3.min.js"></script>
    <script type="text/javascript" src="./build/js/showdown.js"></script>
    <script type="text/javascript" src="./build/js/showdown-prettify.min.js"></script>
    <script type="text/javascript" src="./build/js/prettify/run_prettify.js"></script>
    
    <script type="text/javascript" src="build/js/dld4e-connections.js"></script>
    <script type="text/javascript" src="build/js/dld4e-draw.js"></script>
    <script type="text/javascript" src="build/js/dld4e-gridlines.js"></script>
    <script type="text/javascript" src="build/js/dld4e-groups.js"></script>
    <script type="text/javascript" src="build/js/dld4e-icons.js"></script>
    <script type="text/javascript" src="build/js/dld4e-title.js"></script>
    <script type="text/javascript" src="build/js/dld4e-notes.js"></script>
    <script type="text/javascript" src="build/js/dld4e-process.js"></script>


    <script type="text/javascript" src="build/js/app.js"></script>

</head>
<body ng-app="dld4e" ng-controller="mainController">
      <uib-alert class="col-sm-6 col-sm-offset-3" ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">
        <span ng-bind-html="alert.msg"></span>
      </uib-alert>
      <div class="row">
        <div class="col-sm-6" id="leftSide">
          <div class="row no-gutters">
            <div class="col-sm-11 container-fluid">
                <button id="save" class="btn btn-black btn-sm" ng-click="save()">
                    <span ng-class="saveIcon" aria-hidden="true" ></span> <span ng-bind="state"></span>
                </button>
                <button id="fork" class="btn btn-black btn-sm" ng-click="fork()">
                   <span class="fa fa-code-fork" aria-hidden="true" ></span> Fork
                </button>
                <button id="download" class="btn btn-black btn-sm" ng-click="saveFile()">
                   <span class="glyphicon glyphicon-floppy-save" aria-hidden="true" ></span> Download
                </button>
                <button id="link" class="btn btn-black btn-sm" ng-click="link()">
                   <span class="fa fa-clipboard" aria-hidden="true" ></span><span ng-bind="linkText">Link</span>
                </button>
                <form class="form-inline">
                  <div class="input-group">
                    <input type="text" size="35" class="form-control input-sm" ng-model="gistURL" placeholder="Load from Github Gist">
                    <span class="input-group-btn">
                      <button class="btn btn-black btn-sm" type="submit" ng-click="gist()">
                        <span class="fa fa-cloud-download"></span>
                      </button>
                    </span>
                  </div>
                </form>
            </div>
            <div class="col-sm-1">
              <button id="draw" class="btn btn-black btn-sm pull-right" ng-click="drawClick(value)" uib-tooltip="hint: press ctrl-enter to refresh the drawing" tooltip-placement="bottom" tooltip-append-to-body="true">
                 <span class="glyphicon glyphicon glyphicon-pencil" aria-hidden="true" ></span> Draw
              </button>
              <button id="saveimage" class="btn btn-black btn-sm pull-right" ng-click="drawClick(value)" uib-tooltip="Save SVG as Image" tooltip-placement="bottom" tooltip-append-to-body="true">
                 <span class="glyphicon glyphicon glyphicon-pencil" aria-hidden="true" ></span> Save
              </button>
            </div>
          </div>
          <div class="row">
            <div ui-ace="aceyamlOptions" ng-model="acedata"></div>
          </div>
        </div>
        <div class="col-sm-6" id="rightSide">
          <div class="row pull-right">
            <div class="btn-group" uib-dropdown is-open="status.isopen1" ng-show="shown">
              <button id="examples" type="button" class="btn btn-black btn-sm" uib-dropdown-toggle ng-disabled="disabled">
                Examples<span class="caret"></span>
              </button>
              <ul class="dropdown-menu" uib-dropdown-menu role="menu" aria-labelledby="examples">
                <li role="menuitem" ng-click="example('coffee.yaml')"><a href="javascript:void(0);">Coffee Colors</a></li>
                <li role="menuitem" ng-click="example('curves.yaml')"><a href="javascript:void(0);">Curves</a></li>
                <li role="menuitem" ng-click="example('groups.yaml')"><a href="javascript:void(0);">Groups</a></li>
                <li role="menuitem" ng-click="example('group connections.yaml')"><a href="javascript:void(0);">Group connections</a></li>
                <li role="menuitem" ng-click="example('labels.yaml')"><a href="javascript:void(0);">Labels</a></li>
                <li role="menuitem" ng-click="example('mouseover.yaml')"><a href="javascript:void(0);">Mouseover Metadata</a></li>
                <li role="menuitem" ng-click="example('notes.yaml')"><a href="javascript:void(0);">Notes</a></li>
                <li role="menuitem" ng-click="example('NTP.yaml')"><a href="javascript:void(0);">NTP</a></li>
                <li role="menuitem" ng-click="example('relative positions.yaml')"><a href="javascript:void(0);">Relative positions</a></li>
                <li role="menuitem" ng-click="example('sample.yaml')"><a href="javascript:void(0);">Sample</a></li>
                <li role="menuitem" ng-click="example('text locations.yaml')"><a href="javascript:void(0);">Text locations</a></li>
                <li role="menuitem" ng-click="example('urls.yaml')"><a href="javascript:void(0);">URLs for icons</a></li>
              </ul>
            </div>
            <div class="btn-group" uib-dropdown is-open="status.isopen2" ng-show="shown">
              <button id="foo" type="button" class="btn btn-black btn-sm" uib-dropdown-toggle ng-disabled="disabled">
                Icons<span class="caret"></span>
              </button>
              <ul class="dropdown-menu" uib-dropdown-menu role="menu" aria-labelledby="icons">
                <li role="menuitem" ng-click="drawIconFamily('aws-native')"><a href="javascript:void(0);">aws</a></li>
                <li role="menuitem" ng-click="drawIconFamily('aws-filled')"><a href="javascript:void(0);">aws (iconFill)</a></li>
                <li role="menuitem" ng-click="drawIconFamily('aws-stroke')"><a href="javascript:void(0);">aws (iconStroke)</a></li>
                <li role="menuitem" ng-click="drawIconFamily('cisco-native')"><a href="javascript:void(0);">cisco</a></li>
                <li role="menuitem" ng-click="drawIconFamily('cisco-filled')"><a href="javascript:void(0);">cisco (iconFill)</a></li>
                <li role="menuitem" ng-click="drawIconFamily('cisco-stroke')"><a href="javascript:void(0);">cisco (iconStroke)</a></li>
                <li role="menuitem" ng-click="drawIconFamily('azureEnterprise-native')"><a href="javascript:void(0);">azureEnterprise</a></li>
                <li role="menuitem" ng-click="drawIconFamily('azureEnterprise-filled')"><a href="javascript:void(0);">azureEnterprise (iconFill)</a></li>
                <li role="menuitem" ng-click="drawIconFamily('azureEnterprise-stroke')"><a href="javascript:void(0);">azureEnterprise (iconStroke)</a></li>
                <li role="menuitem" ng-click="drawIconFamily('azureCloud-native')"><a href="javascript:void(0);">azureCloud</a></li>
                <li role="menuitem" ng-click="drawIconFamily('azureCloud-filled')"><a href="javascript:void(0);">azureCloud (iconFill)</a></li>
                <li role="menuitem" ng-click="drawIconFamily('azureCloud-stroke')"><a href="javascript:void(0);">azureCloud (iconStroke)</a></li>
              </ul>
            </div>
            <a href="http://github.com/cidrblock/network_diagram" target="_blank" class="btn btn-black btn-sm">
              <span class="fa fa-github"></span> Github
            </a>
            <button id="fullScreen" class="btn btn-black btn-sm" ng-click="fullScreen()">
               <span class="fa fa-pencil-square-o" aria-hidden="true"></span><span ng-bind="mode"></span>
            </button>
          </div>
          <div class="row">
            <div class="drawing" id="svg"></div>
          </div>
        </div>
      </div>
    </div>
</body>

<script>

var btn = document.getElementById('saveimage');

angular
    .module("dld4e", ['ui.bootstrap', 'ui.ace'])
    .controller("mainController", mainController)

mainController.$inject = ["$scope", "$http", "$sce", "$log", "$window", "$location", "$timeout", "$animate"];

function mainController($scope, $http, $sce, $log, $window, $location, $timeout, $animate) {

  var w = angular.element($window);
  w.bind('resize', function () {
    $scope.drawClick()
  });
  $scope.mode = " Hide editor"
  $scope.shown = true
  $scope.design = "";
  $scope.gistURL = "";
  $scope.dbURL = "https://syg5y0qnyf.execute-api.us-west-2.amazonaws.com/prod/"
  $scope.saveIcon = "glyphicon glyphicon-floppy-disk"
  $scope.linkText = " Link"
  $scope.docId = $window.location.hash.substring(2)
  if ($scope.docId)  {
    $scope.url = $scope.dbURL + $scope.docId
    $scope.state = "Update";
    var leftSide = angular.element( document.querySelector( '#leftSide' ) );
    var rightSide = angular.element( document.querySelector( '#rightSide' ) );
    $scope.shown = false
    $scope.mode = " Show editor"
    $animate.setClass(leftSide, 'ng-hide', 'ng-show').then(function() {
      $animate.setClass(rightSide, 'col-sm-12', 'col-sm-6').then(function() {
        $http.get($scope.url)
             .then(function(res){
                $scope.acedata = res.data;
                $scope.drawClick()
              });
      })
    })
  } else {
    $scope.url = 'examples/NTP.yaml'
    $scope.state = "Save";
    $http.get($scope.url)
         .then(function(res){
            $scope.acedata = res.data;
            $scope.drawClick()
          });
  }

  $scope.aceyamlOptions = {
    onLoad: function (_ace) {
      _ace.getSession().setMode("ace/mode/yaml");
      _ace.$blockScrolling = Infinity;
      _ace.commands.addCommand({
          name: 'saveFile',
          bindKey: {
          win: 'Ctrl-S',
          mac: 'Command-S',
          sender: 'editor|cli'
          },
          exec: function(env, args, request) {
            $scope.saveFile();
          }
          });
      _ace.setOption("tabSize", 2);
    }
  };
  $scope.opend3js = function(greeting) {
    $window.design = jsyaml.load($scope.acedata) || {};
    var w = $window.open("fullscreen.html");
  };
  $scope.drawIconFamily = function(iconFamily) {
    var wi = window.open('about:blank', '_blank');
    $http.get('./build/js/iconFamilies.json')
     .then(function(res){
       var iconFamilies = res.data
       var bestFit = Math.ceil(Math.sqrt(size))
       var familyName = iconFamily.split('-')[0]
       var size = iconFamilies[familyName].length
       var url = "./templates/" + iconFamily + ".yaml"
       $http.get(url)
            .then(function(res){
               var doc = jsyaml.load(res.data);
               var ratios = doc.diagram.aspectRatio.split(':')
               var h = ratios[0]
               var w = ratios[1]
               doc.diagram.rows = Math.ceil(Math.sqrt(size*w/h))
               doc.diagram.columns = Math.ceil(size/doc.diagram.rows)
               var x = 0
               var y = doc.diagram.rows - 1
               doc.icons = {}
               for (var icon in iconFamilies[familyName]){
                 doc.icons[iconFamilies[familyName][icon]] = Object.assign( { x: x, y: y, icon: iconFamilies[familyName][icon]}, doc.icon)
                 x += 1
                 if (x == doc.diagram.columns) {
                   x = 0
                   y -= 1
                 }
               }
               $window.design = doc;
               wi.location.href = 'fullscreen.html';
             });
    });
  }
  $scope.example = function(file) {
    $http.get("examples/" + file)
         .then(function(res){
            $scope.acedata = res.data;
            $window.location.hash = ""
            $scope.state = "Save"
            $scope.drawClick();
          });
  }

  $scope.drawClick = function() {
    $window.design = jsyaml.load($scope.acedata) || {};
    draw($window.design);
    $window.document.title = 'drawthe.net: ' + window.design.title.text
  }


  $scope.gist = function() {
    var parts = $scope.gistURL.split('/')
    var githubUser = parts[3]
    var githubGist = parts[4]
    $http.get('//gist.githubusercontent.com/' + githubUser + '/' + githubGist + '/raw')
      .then(function(res) {
        $scope.acedata = res.data;
        $scope.drawClick()
      })
    $scope.gistURL = ""
    $window.location.hash = ""
    $scope.state = "Save"
  }

  $scope.link = function() {
    copyToClipboard($location.absUrl())
    $scope.linkText = " Copied to clipboard"
    $timeout(function () {
      $scope.linkText = "Link"
    }, 200);
  }

  $scope.fork = function() {
    $scope.state = "Save"
    $scope.save()
  }

  $scope.fullScreen = function () {
    var leftSide = angular.element( document.querySelector( '#leftSide' ) );
    var rightSide = angular.element( document.querySelector( '#rightSide' ) );

    if ($scope.shown) {
      $scope.shown = false
      $scope.mode = " Show editor"
      $animate.setClass(leftSide, 'ng-hide', 'ng-show').then(function() {
        $animate.setClass(rightSide, 'col-sm-12', 'col-sm-6').then(function() {
          $scope.drawClick();
        })
      })
    } else {
      $scope.shown = true
      $scope.mode = " Hide editor"
      $animate.setClass(leftSide, 'ng-show', 'ng-hide').then(function() {
        $animate.setClass(rightSide, 'col-sm-6', 'col-sm-12').then(function() {
          $scope.drawClick();
        })
      })
    }
  }


  $scope.save = function() {
    if ($scope.state == "Save") {
      $scope.saveIcon = "glyphicon glyphicon-hourglass"
      var data = $scope.acedata;
      var config = {
                  headers : {
                      'Content-Type': 'text/x-yaml'
                  }
              }
      $http.post($scope.dbURL, data, config)
       .then(
           function(response){
             $scope.docId = response.data.docId
             $window.location.hash=response.data.docId
             $scope.saveIcon = "glyphicon glyphicon-ok-circle"
             $timeout(function () {
               $scope.saveIcon = "glyphicon glyphicon-floppy-disk";
               $scope.state = "Update";
             }, 200);
           },
           function(response){
             $scope.saveIcon = "glyphicon glyphicon-alert";
             console.log(response)
           }
        );
    } else if ($scope.state == "Update") {
       $scope.saveIcon = "glyphicon glyphicon-hourglass"
        var url = $scope.dbURL + $scope.docId;
        var data = $scope.acedata;
        var config = {
                  headers : {
                      'Content-Type': 'text/x-yaml'
                  }
              }
        $http.put(url, data, config)
         .then(
             function(response){
               $window.location.hash=response.data.docId
               $scope.saveIcon = "glyphicon glyphicon-ok-circle"
               $timeout(function () {
                 $scope.saveIcon = "glyphicon glyphicon-floppy-disk"
               }, 200);

             },
             function(response){
               $scope.saveIcon = "glyphicon glyphicon-alert";
               console.log(response)
             }
          );
    }
  }
  $scope.saveFile = function() {
    var data = $scope.acedata,
        blob = new Blob([data], { type: 'text/plain' }),
        url = $window.URL || $window.webkitURL;
        design = jsyaml.load(data) || {};
        fileName = `${design.title.text || 'dld4e'}-v${design.title.version || '1.01'}.yaml`
    url = url.createObjectURL(blob); //do
    var downloadLink = document.createElement("a");
    downloadLink.href = url;
    downloadLink.download = fileName;
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
  }
};

btn.addEventListener('click', function() {
    out$.saveSvgAsPng(document.querySelector('svg'), 'diagram.png');
});

function outerHTML(el) {
    var outer = document.createElement('div');
    outer.appendChild(el.cloneNode(true));
    return outer.innerHTML;
}

/*
function styles(dom) {
    var used = "";
    var sheets = document.styleSheets;
    for (var i = 0; i < sheets.length, i++) {
        var rules = sheets[i[.cssRules;
        for (var j = 0, j < rules.length; j++) {
            var rule = rules[j];
            if (typeof(rule.style) != "undefined") {
                var elems = dom.querySelectorAll(rule.selectorText);
                if (elems.length > 0) {
                    used += rule.selectorText + " {  " + rule.style.cssText + " }\n";
                }
            }
        }
    }

    var s = document.createElement('style');
    s.setAttribute('type', 'text/css');
    s.innerHTML = "<![CDATA[\n" + used + "\n]]>";

    var defs = document.createElement('defs');
    defs.appendChild(s);
    dom.insertBefore(defs, dom.firstChild);
};
*/

var out$ = typeof exports != 'undefined' && exports || typeof define != 'undefined' && {} || this;

var doctype = '<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd" [<!ENTITY nbsp "&#160;">]>';

function isElement(obj) {
return obj instanceof HTMLElement || obj instanceof SVGElement;
}

function requireDomNode(el) {
if (!isElement(el)) {
  throw new Error('an HTMLElement or SVGElement is required; got ' + el);
}
}

function isExternal(url) {
return url && url.lastIndexOf('http',0) == 0 && url.lastIndexOf(window.location.host) == -1;
}

function inlineImages(el, callback) {
requireDomNode(el);

var images = el.querySelectorAll('image'),
    left = images.length,
    checkDone = function() {
      if (left === 0) {
        callback();
      }
    };

checkDone();
for (var i = 0; i < images.length; i++) {
  (function(image) {
    var href = image.getAttributeNS("http://www.w3.org/1999/xlink", "href");
    if (href) {
      if (isExternal(href.value)) {
        console.warn("Cannot render embedded images linking to external hosts: "+href.value);
        return;
      }
    }
    var canvas = document.createElement('canvas');
    var ctx = canvas.getContext('2d');
    var img = new Image();
    img.crossOrigin="anonymous";
    href = href || image.getAttribute('href');
    if (href) {
      img.src = href;
      img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        image.setAttributeNS("http://www.w3.org/1999/xlink", "href", canvas.toDataURL('image/png'));
        left--;
        checkDone();
      }
      img.onerror = function() {
        console.log("Could not load "+href);
        left--;
        checkDone();
      }
    } else {
      left--;
      checkDone();
    }
  })(images[i]);
}
}

function styles(el, selectorRemap, modifyStyle) {
var css = "";
var sheets = document.styleSheets;
for (var i = 0; i < sheets.length; i++) {
  try {
    var rules = sheets[i].cssRules;
  } catch (e) {
    console.warn("Stylesheet could not be loaded: "+sheets[i].href);
    continue;
  }

  if (rules != null) {
    for (var j = 0, match; j < rules.length; j++, match = null) {
      var rule = rules[j];
      if (typeof(rule.style) != "undefined") {
        var selectorText;

        try {
          selectorText = rule.selectorText;
        } catch(err) {
          console.warn('The following CSS rule has an invalid selector: "' + rule + '"', err);
        }

        try {
          if (selectorText) {
            match = el.querySelector(selectorText);
          }
        } catch(err) {
          console.warn('Invalid CSS selector "' + selectorText + '"', err);
        }

        if (match) {
          var selector = selectorRemap ? selectorRemap(rule.selectorText) : rule.selectorText;
          var cssText = modifyStyle ? modifyStyle(rule.style.cssText) : rule.style.cssText;
          css += selector + " { " + cssText + " }\n";
        } else if(rule.cssText.match(/^@font-face/)) {
          css += rule.cssText + '\n';
        }
      }
    }
  }
}
return css;
}

function getDimension(el, clone, dim) {
var v = (el.viewBox && el.viewBox.baseVal && el.viewBox.baseVal[dim]) ||
  (clone.getAttribute(dim) !== null && !clone.getAttribute(dim).match(/%$/) && parseInt(clone.getAttribute(dim))) ||
  el.getBoundingClientRect()[dim] ||
  parseInt(clone.style[dim]) ||
  parseInt(window.getComputedStyle(el).getPropertyValue(dim));
return (typeof v === 'undefined' || v === null || isNaN(parseFloat(v))) ? 0 : v;
}

function reEncode(data) {
data = encodeURIComponent(data);
data = data.replace(/%([0-9A-F]{2})/g, function(match, p1) {
  var c = String.fromCharCode('0x'+p1);
  return c === '%' ? '%25' : c;
});
return decodeURIComponent(data);
}

out$.svgAsDataUri = function(el, options, cb) {
requireDomNode(el);

options = options || {};
options.scale = options.scale || 1;
options.responsive = options.responsive || false;
var xmlns = "http://www.w3.org/2000/xmlns/";

inlineImages(el, function() {
  var outer = document.createElement("div");
  var clone = el.cloneNode(true);
  var width, height;
  if(el.tagName == 'svg') {
    width = options.width || getDimension(el, clone, 'width');
    height = options.height || getDimension(el, clone, 'height');
  } else if(el.getBBox) {
    var box = el.getBBox();
    width = box.x + box.width;
    height = box.y + box.height;
    clone.setAttribute('transform', clone.getAttribute('transform').replace(/translate\(.*?\)/, ''));

    var svg = document.createElementNS('http://www.w3.org/2000/svg','svg')
    svg.appendChild(clone)
    clone = svg;
  } else {
    console.error('Attempted to render non-SVG element', el);
    return;
  }

  clone.setAttribute("version", "1.1");
  if (!clone.getAttribute('xmlns')) {
    clone.setAttributeNS(xmlns, "xmlns", "http://www.w3.org/2000/svg");
  }
  if (!clone.getAttribute('xmlns:xlink')) {
    clone.setAttributeNS(xmlns, "xmlns:xlink", "http://www.w3.org/1999/xlink");
  }

  if (options.responsive) {
    clone.removeAttribute('width');
    clone.removeAttribute('height');
    clone.setAttribute('preserveAspectRatio', 'xMinYMin meet');
  } else {
    clone.setAttribute("width", width * options.scale);
    clone.setAttribute("height", height * options.scale);
  }

  clone.setAttribute("viewBox", [
    options.left || 0,
    options.top || 0,
    width,
    height
  ].join(" "));

  var fos = clone.querySelectorAll('foreignObject > *');
  for (var i = 0; i < fos.length; i++) {
    if (!fos[i].getAttribute('xmlns')) {
      fos[i].setAttributeNS(xmlns, "xmlns", "http://www.w3.org/1999/xhtml");
    }
  }

  outer.appendChild(clone);

  var css = styles(el, options.selectorRemap, options.modifyStyle);
  var s = document.createElement('style');
  s.setAttribute('type', 'text/css');
  s.innerHTML = "<![CDATA[\n" + css + "\n]]>";
  var defs = document.createElement('defs');
  defs.appendChild(s);
  clone.insertBefore(defs, clone.firstChild);

  var svg = doctype + outer.innerHTML;
  var uri = 'data:image/svg+xml;base64,' + window.btoa(reEncode(svg));
  if (cb) {
    cb(uri);
  }
});
}

out$.svgAsPngUri = function(el, options, cb) {
requireDomNode(el);

options = options || {};
options.encoderType = options.encoderType || 'image/png';
options.encoderOptions = options.encoderOptions || 0.8;

out$.svgAsDataUri(el, options, function(uri) {
  var image = new Image();
  image.onload = function() {
    var canvas = document.createElement('canvas');
    canvas.width = image.width;
    canvas.height = image.height;
    var context = canvas.getContext('2d');
    if(options && options.backgroundColor){
      context.fillStyle = options.backgroundColor;
      context.fillRect(0, 0, canvas.width, canvas.height);
    }
    context.drawImage(image, 0, 0);
    var a = document.createElement('a'), png;
    try {
      png = canvas.toDataURL(options.encoderType, options.encoderOptions);
    } catch (e) {
      if ((typeof SecurityError !== 'undefined' && e instanceof SecurityError) || e.name == "SecurityError") {
        console.error("Rendered SVG images cannot be downloaded in this browser.");
        return;
      } else {
        throw e;
      }
    }
    cb(png);
  }
  image.onerror = function() {
    console.error(
      'There was an error loading the data URI as an image on the following SVG\n',
      window.atob(uri.slice(26)), '\n',
      "Open the following link to see browser's diagnosis\n",
      uri);
  }
  image.src = uri;
});
}

function download(name, uri) {
if (navigator.msSaveOrOpenBlob) {
  navigator.msSaveOrOpenBlob(uriToBlob(uri), name);
} else {
  var saveLink = document.createElement('a');
  var downloadSupported = 'download' in saveLink;
  if (downloadSupported) {
    saveLink.download = name;
    saveLink.href = uri;
    saveLink.style.display = 'none';
    document.body.appendChild(saveLink);
    saveLink.click();
    document.body.removeChild(saveLink);
  }
  else {
    window.open(uri, '_temp', 'menubar=no,toolbar=no,status=no');
  }
}
}
out$.download = download;

function uriToBlob(uri) {
var byteString = window.atob(uri.split(',')[1]);
var mimeString = uri.split(',')[0].split(':')[1].split(';')[0]
var buffer = new ArrayBuffer(byteString.length);
var intArray = new Uint8Array(buffer);
for (var i = 0; i < byteString.length; i++) {
  intArray[i] = byteString.charCodeAt(i);
}
return new Blob([buffer], {type: mimeString});
}

out$.saveSvg = function(el, name, options) {
requireDomNode(el);

options = options || {};
out$.svgAsDataUri(el, options, function(uri) {
  download(name, uri);
});
}

out$.saveSvgAsPng = function(el, name, options) {
requireDomNode(el);

options = options || {};
out$.svgAsPngUri(el, options, function(uri) {
  download(name, uri);
});
}

// if define is defined create as an AMD module
if (typeof define !== 'undefined') {
define(function() {
  return out$;
});
}

</script>

</html>
